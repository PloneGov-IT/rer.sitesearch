<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="rer.sitesearch">
<head>
    <metal:block metal:fill-slot="head_slot">
        <link rel="alternate" title="RSS 1.0" type="application/rss+xml"
              tal:condition="request/SearchableText|nothing"
              tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}"/>
    </metal:block>

    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1)" />
    <metal:block fill-slot="column_one_slot" />
    <metal:block fill-slot="column_two_slot" />
	
</head>

<body>
<div metal:fill-slot="main"
     tal:define="use_types_blacklist request/use_types_blacklist | python:True;
                 use_navigation_root request/use_navigation_root | python:True;
                 results python:here.queryCatalog(REQUEST=request,use_types_blacklist=use_types_blacklist, use_navigation_root=use_navigation_root);
                 Batch python:modules['Products.CMFPlone'].Batch;
                 b_size python:20;
				 b_start python:int(request.form.get('b_start','0'));
                 desc_length site_properties/search_results_description_length;
                 desc_ellipsis site_properties/ellipsis;
                 searchterm request/SearchableText|nothing;
                 use_view_action site_properties/typesUseViewActionInListings|python:();
				 sitesearch_view nocall: context/@@sitesearch_view;
				 template_id string:search;
				 selected_tab python:request.form.get('selected_tab','');">
	
	<h1 class="" i18n:translate=""
		tal:condition="python:request.form.get('path','') and request.form.get('path') != '/'.join(context.portal_url.getPortalObject().getPhysicalPath())">
		You searched in: <span tal:content="python:sitesearch_view.getFolderName(request.form.get('path'))" i18n:name="folder_name">Folder</span> 
	</h1>	           
	
    <div  class="searchResults"  tal:condition="not: results">
        <p><strong i18n:translate="description_no_results_found">No results were found.</strong></p>
    </div>
	<tal:search_view define="divided_results python: sitesearch_view.getDividedResults(results);
							 results_elements python:divided_results.has_key(selected_tab) and divided_results.get(selected_tab) or divided_results.get('all');
					  		 res_uids python:sitesearch_view.getUids(results_elements['results']);">
		
    <div class="searchResults" tal:condition="results"
          tal:define="portal_types portal/portal_types;
					  tabs_order divided_results/tabs_order">
			<ul class="searchTabs">
				<tal:tabs repeat="key tabs_order">
					<li tal:condition="python:divided_results.has_key(key) and divided_results[key].get('results',[])"
						tal:define="isFirst repeat/key/start"
						tal:attributes="id python:divided_results[key].get('id')">				            	
						<a class=""
						   tal:attributes="class python:sitesearch_view.getTabClass(divided_results[key].get('id'),divided_results.keys(),selected_tab,isFirst);
						   				   href python:sitesearch_view.setTabUrl(template_id,divided_results[key].get('id'))"
						   i18n:translate=""
						   tal:content="python:divided_results[key].get('title')">
							Document
						</a>
					</li>
				</tal:tabs>
			</ul>
			<div class="searchData"
				 tal:define="results_block python:divided_results.has_key(selected_tab) and divided_results.get(selected_tab) or divided_results.get('all');
							 batch python:Batch(results_block['results'], b_size, int(b_start), orphan=1)">
										   
				<div class="rnum" tal:define="number_part_results python: len(results_block['results']);
											  number_total_results python: len(results)">
					<tal:total i18n:translate="view_number_of_results" condition="python: number_total_results != 1 and number_part_results != 1">
						<span class="resType"><tal:part replace="number_part_results" i18n:name="number_part_results" /> results</span> of this type of
						<span class="resTot"><tal:total replace="number_total_results" i18n:name="number_total_results" /> total results</span>
					</tal:total>
					<span i18n:translate="view_number_of_results_part1" tal:condition="python: number_total_results != 1 and number_part_results == 1">
						<tal:part replace="number_part_results" i18n:name="number_part_results" /> result of this type of
						<tal:total replace="number_total_results" i18n:name="number_total_results" /> total results
					</span>
					<span i18n:translate="view_number_of_results_total1" tal:condition="python: number_total_results == 1">
						<tal:part replace="number_part_results" i18n:name="number_part_results" /> result of this type of
						<tal:total replace="number_total_results" i18n:name="number_total_results" /> total result
					</span>
				</div>
				<p class="discreet document-action-rss"
			       tal:condition="syntool/isSiteSyndicationAllowed">
			        <a href=""
					tal:define="query_string python:sitesearch_view.getQueryString(request.form)"
			           	class="link-feed"
			           	i18n:translate="title_rss_feed"
			           	tal:attributes="href string:$here_url/search_rss?${query_string}">
			             RSS feed</a>
			    </p>
				<dl>
					<tal:results repeat="result batch">
						        <tal:entry define="result_url result/getURL;
						                           result_type result/portal_type;
						                           item_icon python:plone_view.getIcon(result);
						                           url python:'%s?searchterm=%s'%(test(result_type in use_view_action, result_url+'/view', result_url+'/'), searchterm);">
						          <dt tal:define="item_wf_state_class string:state-${result/review_state};"
						              tal:attributes="class python:'searchResTitle contenttype-' + normalizeString(result.portal_type)">
						              <img tal:replace="structure item_icon/html_tag" />
						              <a href="#" 
						                 tal:attributes="href url; class string:$item_wf_state_class"
						                 tal:content="result/pretty_title_or_id" />
						          </dt>
						          <dd class="itemDescr">
						                <span class="searchResDate"
											  >
						                    <tal:date condition="result/EffectiveDate">
						                    	<span tal:replace="python:toLocalizedTime(result.EffectiveDate)">
						                    		August 16, 2001 at 23:35:59
						                    	</span>
						                    </tal:date>
						                </span>
										<tal:separator condition="python:result.EffectiveDate !='None' and result.Description">
											-
										</tal:separator>
						                <span tal:replace="python:plone_view.cropText(result.Description, desc_length, desc_ellipsis)">
						                    Cropped description
						                </span>
						                <p class="documentByLine"
											  i18n:domain="plone"
						                	tal:condition="python:not isAnon or site_properties.allowAnonymousViewAbout">
						                	
						                	<span class="documentAuthor"
							                    i18n:translate="label_by_author">
								                by
								                <a href="#"
								                   tal:attributes="href string:${portal_url}/author/${result/Creator}"
								                   tal:content="result/Creator"
								                   tal:omit-tag="not:result/Creator"
								                   i18n:name="author">
								                Bob Dobalina
								                </a>
							                </span>
							                <span tal:define="categories result/Subject|nothing"
							                      tal:condition="categories">
							                    &mdash;
							                    <tal:filedunder i18n:translate="label_filed_under">filed under:</tal:filedunder>
							                        <span tal:repeat="category categories">
							                            <a href=""
							                               class="link-category"
							                               rel="tag"
							                               tal:content="category"
							                               tal:attributes="href string:${portal_url}/search?Subject%3Alist=${category}">
							                               Category
							                            </a><tal:separator condition="not: repeat/category/end">,</tal:separator>
							                        </span>
							                </span>
							                
						            	</p>
						            </dd>
						        </tal:entry>
					        </tal:results>
					
				</dl>
				<div metal:use-macro="here/batch_macros/macros/navigation" />
			</div>
    </div>
	<tal:searchform>
			<form action="search"
		          class="enableAutoFocus"
		          method="post"
		          id="search"
		          tal:define="DateTime python:modules['DateTime'].DateTime">
				
		        <fieldset id="search_column">
		
		            <legend i18n:translate="less_results">Refine your search: </legend>
		
		            <div id="rerSearchText" class="field">
		                <label for="SearchableText" i18n:translate="label_search_text">Search text</label>
		
		                <input type="text"
		                       id="SearchableText"
		                       name="SearchableText"
		                       tal:attributes="value request/SearchableText|nothing"
		                       />
		                <input class="context submitSearch"
		                       type="submit"
		                       name="submit"
		                       value="Search"
							   i18n:domain="plone"
		                       i18n:attributes="value label_search;"
		                       />
		            </div>
		            				
					<div class="visualClear" id="clear-space-before-submit"><!-- --></div>
					
					<!--PATH-->
					<div class="fieldsets"
						 tal:condition="python:request.form.get('path') and request.form.get('path') != '/'.join(context.portal_url.getPortalObject().getPhysicalPath())">
						<h3 i18n:translate="label_search_in">Search in</h3>
						
			            <input id="searchbox_currentfolder_only" 
			                   class="noborder"
			                   type="radio" 
			                   name="path"
			                   tal:attributes="value request/form/path|string:${context/portal_url};
							   				   checked request/form/path|nothing"/>
						<label for="searchbox_currentfolder_only" 
			                   style="cursor: pointer"
							   tal:content="python:sitesearch_view.getFolderName(request.form.get('path'))">
			                
			            </label>
						<br />
						<input id="searchbox_all_site" 
			                   class="noborder"
			                   type="radio" 
			                   name="path"
							   value=""
			                   tal:attributes="checked not:request/form/path|nothing"/>
							   
						<label for="searchbox_all_site" 
			                   i18n:translate="label_searchbox_all_site"
			                   style="cursor: pointer">
			                All the site
			            </label>
					</div>
				
		            <!--div tal:define="portal_types portal/portal_types;
		            				 allTypes python:putils.getUserFriendlyTypes();"
		            	 tal:repeat="type allTypes">
		            	 <tal:block condition="python: type!='Folder' and type!='FolderTaxonomy' ">
		            	 	<input type="hidden" name="portal_type:list" tal:attributes="value type">
		            	 </tal:block>
		            </div-->
					
					<!--Ordinamento-->
					<div class="fieldsets"
						tal:define="sort_on request/sort_on|nothing">
						<h3 i18n:translate="sort_on">Sort on</h3>
						<div class="fieldsetsItem fieldsetOrderBy">	
							<input	type="radio"
									class="noborder"
									id="sort_on-similarity"
									name="sort_on"
									value=""
									tal:attributes="checked python:str(sort_on) != 'effective'"/>
							<label for="sort_on-similarity" i18n:translate="closer_results">Closer results</label>
							<input	type="radio"
									class="noborder"
									id="sort_on-date"
									name="sort_on"
									value="effective"
									tal:attributes="checked python: sort_on == 'effective'"/>
							
							
							<label for="sort_on-date" i18n:translate="latest_results">Latest results</label>
							<input type="hidden" id="sortOrderField" tal:condition="python:not request.form.has_key('sort_on') or request.form.get('sort_on')==''" name="sort_order" value=""/>
							<input type="hidden" id="sortOrderField" tal:condition="python:request.form.get('sort_on')=='effective'" name="sort_order" value="reverse"/>
						</div>
					</div>
					
					<!--SUBJECTS-->
		            <div class="fieldsets" tal:define="checked_subjects request/Subject|nothing;
													   usedSubjects python:sitesearch_view.getKeywordList(res_uids,'Subject');
													   show_subjects python:sitesearch_view.showSubjects()"
										   tal:condition="python:usedSubjects and show_subjects">
		            	<h3 i18n:translate="label_categories">Categories</h3>
		
						<div class="fieldsetsItem"
		                     tal:repeat="subject usedSubjects">
			                    <input type="checkbox"
			                           name="Subject:list"
			                           value="#"
			                           class="noborder"
			                           tal:attributes="value subject;
			                           				   id string:subject_${repeat/subject/number};
			                           				   checked python: checked_subjects and subject in checked_subjects"/>
			
			                    <label for=""
									i18n:domain="plone-metadata"
									i18n:translate=""
									tal:attributes="for string:subject_${repeat/subject/number}"
									tal:content="subject"
			                    	/>
						</div>
						<div class="fieldsetsItem linkRemoveFilters"
							tal:condition="checked_subjects">
							<a class="portal-breadcrumbs"
								id="deselect-subjects"
								href="search">
								<span i18n:translate="label_remove_filters">Remove all filters</span>
							</a>
						</div>
						
						<input type="hidden"
							   name="Subject_usage:ignore_empty"
							   id="Subject_and"
							   value="operator:and"/>
		            </div>
					
					
					<!--ADDITIONAL INDEXES and FACETED-->
                    <tal:additional_indexes define="additional_indexes_list python:sitesearch_view.getAdditionalIndexesList(res_uids)"
                                            condition="additional_indexes_list"
                                 tal:repeat="additional_index additional_indexes_list">
                                    
                        <!--ITERATION additional_indexes-->                 
                        <div class="fieldsets" 
                            tal:define="index_name python:additional_index.get('index_name');
                                        index_title python:additional_index.get('index_title');
                                        index_elements python:additional_index.get('indexes_list');
                                        checked_index python:request.get(index_name,[]);"
                            tal:condition="index_elements">
                            <h3 i18n:translate="" tal:content="index_title">Index Keyword</h3>
                        
                                 <div tal:repeat="kw index_elements" class="fieldsetsItem">
                                    <input type="checkbox"
                                           value="#"
                                           class="noborder"
                                           tal:attributes="name string:${index_name}:list; 
                                                           value python:kw;
                                                           id string:${index_name}_${repeat/kw/number};
                                                           checked python:kw in checked_index"/>
                
                                    <label for=""
                                        i18n:domain="plone-metadata"
                                        i18n:translate=""
                                        tal:attributes="for string:${index_name}_${repeat/kw/number};"
                                        tal:content="kw"
                                        />
                            </div>
                            <div class="fieldsetsItem linkRemoveFilters"
                                tal:condition="checked_index">
                                <a class="portal-breadcrumbs"
                                    href="search"
                                    tal:condition="checked_index"
                                    onclick=""
                                    tal:attributes="id string:deselect-${index_name};
                                                    onclick string:javascript:removeAdditionalIndexFilter('${index_name}');;return false">
                                    <span i18n:translate="label_remove_filters">Remove all filters</span>
                                </a>
                            </div>
                            <input type="hidden"
                                   tal:attributes="name string:${index_name}_usage:ignore_empty;
                                                   id string:${index_name}_and"
                                   value="operator:and"/>
                        </div>
                    </tal:additional_indexes>
                    
                    <div class="visualClear" ><!-- --></div>
        
                    <div class="formControls">
                        <input class="context submitSearch"
                               type="submit"
                               name="submit"
                               value="Search"
                               i18n:domain="plone"
                               i18n:attributes="value label_search;"
                               />
                    </div>
				
		        </fieldset>
		    	
				<input type="hidden"
					   id="selected_tab"
					   name="selected_tab"
					   tal:attributes="value python:request.form.get('selected_tab','')"/>
				
				<input type="hidden"
					   id="b_start"
					   name="b_start"
					   tal:attributes="value b_start"/>
		    </form>
    	</tal:searchform>   
		</tal:search_view>
		<div class="visualClear"><!-- --></div>
</div>
</body>
</html>

