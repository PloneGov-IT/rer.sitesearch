<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="rer.sitesearch">
<head>
    <metal:block metal:fill-slot="head_slot">
        <link rel="alternate" title="RSS 1.0" type="application/rss+xml"
              tal:condition="request/SearchableText|nothing"
              tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}"/>
    </metal:block>

    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1)" />
    <metal:block fill-slot="column_one_slot" />
    <metal:block fill-slot="column_two_slot" />
	
</head>

<body>
<div metal:fill-slot="main"
     tal:define="use_types_blacklist request/use_types_blacklist | python:True;
                 use_navigation_root request/use_navigation_root | python:True;
                 results python:here.queryCatalog(REQUEST=request,use_types_blacklist=use_types_blacklist, use_navigation_root=use_navigation_root);
                 Batch python:modules['Products.CMFPlone'].Batch;
                 b_size python:30;b_start python:0;b_start request/b_start | b_start;
                 desc_length site_properties/search_results_description_length;
                 desc_ellipsis site_properties/ellipsis;
                 searchterm request/SearchableText|nothing;
                 use_view_action site_properties/typesUseViewActionInListings|python:();">

   
    <div  class="searchResults"  tal:condition="not: results">
        <p><strong i18n:translate="description_no_results_found">No results were found.</strong></p>
    </div>
	<tal:search_view define="results_division nocall: context/@@results_division;
				  			 res_uids python:results_division.getUids(results);">
		
    <div class="searchResults" tal:condition="results"
          tal:define="divided_results python: results_division.getDividedResults(results);
					  portal_types portal/portal_types;">
		<dl class="searchResults"
			tal:define="tabs_order python:['All','Document','News Item','Event','File','Link']">
			<tal:for repeat="key tabs_order">
				<dt tal:condition="python:divided_results.has_key(key)">
					<a class="linetab" tal:content="python:divided_results[key].get('title')"
					   tal:attributes="href python:'#to-block-'+divided_results[key].get('id')">
						Document
					</a>
				</dt>
			</tal:for>
			<tal:blocks repeat="key tabs_order">
				<dd tal:condition="python:divided_results.has_key(key)"
					tal:define="isFirst repeat/key/start"
				    tal:attributes="class python:isFirst and 'visualClear searchData firstSearchBlock' or 'visualClear searchData';
					                id string:searchDataBlock${repeat/key/number};">
					<div class="rnum" tal:define="number_part_results python: len(divided_results[key]['results']);
												  number_total_results python: len(results)">
						<span i18n:translate="view_number_of_results" tal:condition="python: number_total_results != 1 and number_part_results != 1">
							<tal:part replace="number_part_results" i18n:name="number_part_results" /> results of this type of
							<tal:total replace="number_total_results" i18n:name="number_total_results" /> total results
						</span>
						<span i18n:translate="view_number_of_results_part1" tal:condition="python: number_total_results != 1 and number_part_results == 1">
							<tal:part replace="number_part_results" i18n:name="number_part_results" /> result of this type of
							<tal:total replace="number_total_results" i18n:name="number_total_results" /> total results
						</span>
						<span i18n:translate="view_number_of_results_total1" tal:condition="python: number_total_results == 1">
							<tal:part replace="number_part_results" i18n:name="number_part_results" /> result of this type of
							<tal:total replace="number_total_results" i18n:name="number_total_results" /> total result
						</span>
					</div>
					<h3>
						<a tal:attributes="name python:'#to-block-'+divided_results[key].get('id')"
					       tal:content="python:divided_results[key].get('title')"
						   i18n:translate="">Document</a>
					</h3>
					<dl tal:define="results python: divided_results[key]['results'];
						            batch python:Batch(results, b_size, int(b_start), orphan=1)">
				        <tal:results repeat="result batch">
					        <tal:entry define="result_url result/getURL;
					                           result_type result/portal_type;
					                           item_icon python:plone_view.getIcon(result);
					                           url python:'%s?searchterm=%s'%(test(result_type in use_view_action, result_url+'/view', result_url+'/'), searchterm);">
					          <dt tal:define="item_wf_state_class string:state-${result/review_state};"
					              tal:attributes="class python:'contenttype-' + normalizeString(result.portal_type)">
					              <img tal:replace="structure item_icon/html_tag" />
					              <a href="#" 
					                 tal:attributes="href url; class string:$item_wf_state_class"
					                 tal:content="result/pretty_title_or_id" />
					          </dt>
					          <dd class="itemDescr">
					                <span tal:replace="python:plone_view.cropText(result.Description, desc_length, desc_ellipsis)">
					                    Cropped description
					                </span>
					                <span class="documentByLine"
					                	tal:condition="python:not isAnon or site_properties.allowAnonymousViewAbout">
					                	
					                	<span class="documentAuthor"
						                    i18n:translate="label_by_author">
							                by
							                <a href="#"
							                   tal:attributes="href string:${portal_url}/author/${result/Creator}"
							                   tal:content="result/Creator"
							                   tal:omit-tag="not:result/Creator"
							                   i18n:name="author">
							                Bob Dobalina
							                </a>
						                </span>
						                <span class="documentModified">
						                  &mdash;
						                    <span i18n:translate="box_last_modified">
						                    last modified
						                    </span>
						                    <span tal:replace="python:toLocalizedTime(result.ModificationDate, long_format=1)">
						                    August 16, 2001 at 23:35:59
						                    </span>
						                </span>
						                <span tal:define="categories result/Subject|nothing"
						                      tal:condition="categories">
						                    &mdash;
						                    <tal:filedunder i18n:translate="label_filed_under">filed under:</tal:filedunder>
						                        <span tal:repeat="category categories">
						                            <a href=""
						                               class="link-category"
						                               rel="tag"
						                               tal:content="category"
						                               tal:attributes="href string:${portal_url}/search?Subject%3Alist=${category}">
						                               Category
						                            </a><tal:separator condition="not: repeat/category/end">,</tal:separator>
						                        </span>
						                </span>
						                <span class="relevance" 
						                      tal:condition="result/data_record_normalized_score_">
						                    &mdash;
						                    <tal:relevance i18n:translate="label_relevance_percentage">
						                    Relevance:
						                        <span tal:content="result/data_record_normalized_score_"
						                               tal:omit-tag=""
						                               i18n:name="percentage">23</span>%
						                    </tal:relevance>
						                </span>
					            	</span>
					            </dd>
					        </tal:entry>
				        </tal:results>
			        	<div metal:use-macro="here/batch_macros/macros/navigation" />
			        </dl>
				</dd>
			</tal:blocks>
		</dl>
    </div>
	<tal:searchform >
			<form action="search"
		          class="enableAutoFocus"
		          method="post"
		          id="search"
		          tal:define="DateTime python:modules['DateTime'].DateTime">
				
		        <fieldset id="search_column">
		
		            <legend i18n:translate="less_results">Refine your search: </legend>
		
		            <div id="rerSearchText" class="field">
		                <label for="SearchableText" i18n:translate="label_search_text">Search Text</label>
		
		                <input type="text"
		                       id="SearchableText"
		                       name="SearchableText"
		                       tal:attributes="value request/SearchableText|nothing"
		                       />
		            </div>
		            
					<div class="formControls">
		                <input class="context"
		                       type="submit"
		                       name="submit"
		                       value="Search"
							   i18n:domain="plone"
		                       i18n:attributes="value label_search;"
		                       />
		            </div>
					<div class="visualClear" id="clear-space-before-submit"><!-- --></div>
					<!--PATH-->
					<div class="fieldsets"
						 tal:condition="request/form/path|nothing">
						
						<h3 i18n:translate="label_search_in">Search in</h3>
						
			            <input id="searchbox_currentfolder_only" 
			                   class="noborder"
			                   type="radio" 
			                   name="path"
			                   tal:attributes="value request/form/path|string:${context/portal_url};
							   				   checked request/form/path|nothing"/>
						<label for="searchbox_currentfolder_only" 
			                   style="cursor: pointer"
							   tal:content="request/form/path">
			                
			            </label>
						<br />
						<input id="searchbox_currentfolder_only" 
			                   class="noborder"
			                   type="radio" 
			                   name="path"
							   value=""
			                   tal:attributes="checked not:request/form/path|nothing"/>
							   
						<label for="searchbox_currentfolder_only" 
			                   i18n:translate="label_searchbox_all_site"
			                   style="cursor: pointer">
			                All the site
			            </label>
					</div>
				
		            <!--div tal:define="portal_types portal/portal_types;
		            				 allTypes python:putils.getUserFriendlyTypes();"
		            	 tal:repeat="type allTypes">
		            	 <tal:block condition="python: type!='Folder' and type!='FolderTaxonomy' ">
		            	 	<input type="hidden" name="portal_type:list" tal:attributes="value type">
		            	 </tal:block>
		            </div-->
					
					<!--Ordinamento-->
					<div class="fieldsets"
						tal:define="sort_on request/sort_on|nothing">
					<h3 i18n:translate="sort_on">Sort on</h3>
						
						<input	type="radio"
								class="noborder"
								id="sort_on-similarity"
								name="sort_on"
								value=""
								tal:attributes="checked python:str(sort_on) != 'modified'"/>
						<label for="sort_on-similarity" i18n:translate="closer_results">Closer results</label>
						<input	type="radio"
								class="noborder"
								id="sort_on-date"
								name="sort_on"
								value="modified"
								tal:attributes="checked python: sort_on == 'modified'"/>
						<label for="sort_on-date" i18n:translate="latest_results">Latest results</label>
					</div>
					
					<!--TAG-->
		            <div class="fieldsets" tal:define="checked_subjects request/Subject|nothing;
													   usedSubjects python:results_division.getKeywordList(res_uids,'Subject');
													   show_subjects python:results_division.showSubjects()"
										   tal:condition="python:usedSubjects and show_subjects">
		            	<h3 i18n:translate="label_categories">Categories</h3>
		
						<div tal:define="SubjectsLists python:here.createMultiColumnList(usedSubjects, numCols=4, sort_on='self');"
		                     tal:repeat="sublist SubjectsLists">
							<tal:items repeat="subject sublist">
			                    <input type="checkbox"
			                           name="Subject:list"
			                           value="#"
			                           class="noborder"
			                           tal:attributes="value subject;
			                           				   id string:subject_${repeat/sublist/number}_${repeat/subject/number};
			                           				   checked python: checked_subjects and subject in checked_subjects"/>
			
			                    <label for=""
									i18n:domain="plone-metadata"
									i18n:translate=""
									tal:attributes="for string:subject_${repeat/sublist/number}_${repeat/subject/number}"
									tal:content="subject"
			                    	/>
			                    <br />
			                </tal:items>
							
						</div>
						<div style="text-align:right"
							tal:condition="checked_subjects">
							<a class="portal-breadcrumbs"
								id="deselect-subjects"
								href="search">
								<span i18n:translate="label_remove_filters">Remove all filters</span>
							</a>
						</div>
						
						<input type="hidden"
							   name="Subject_usage:ignore_empty"
							   id="Subject_and"
							   value="operator:and"/>
		            </div>
					
					<!--Site Areas-->					
					<div class="fieldsets" 
						tal:define="checked_siteareas python:request.get('getSiteAreas',[]);
									site_areas_list python:results_division.getTaxonomies(res_uids)"
						tal:condition="site_areas_list">
		                <h3 i18n:translate="thematic_areas">Thematic areas</h3>
		            
						<tal:areas define="sorted_areas python:site_areas_list.keys();
										 dummy_areas python:sorted_areas.sort()">
							 <div tal:repeat="area sorted_areas">
			                    <input type="checkbox"
			                           name="getSiteAreas:list"
			                           value="#"
			                           class="noborder"
			                           tal:attributes="value python:site_areas_list[area];
			                           				   id string:areas_${repeat/area/number};
			                           				   checked python:site_areas_list[area] in checked_siteareas"/>
			
			                    <label for=""
									i18n:domain="plone-metadata"
									i18n:translate=""
									tal:attributes="for string:areas_${repeat/area/number}"
									tal:content="area"
			                    	/>
			                    <br />
						</div>
					 	</tal:areas>
						<div style="text-align:right"
							tal:condition="checked_siteareas">
							<a class="portal-breadcrumbs"
								id="deselect-siteareas"
								href="search">
								<span i18n:translate="label_remove_filters">Remove all filters</span>
							</a>
						</div>
						<input type="hidden"
							   name="getSiteAreas_usage:ignore_empty"
							   id="getSiteAreas_and"
							   value="operator:and"/>
		 			</div>
		 			
					
					<!--FACETED-->
					<tal:faceted define="faceted_dict python:results_division.getFacetedList(res_uids);
										 faceted_keys python:faceted_dict.keys();
										 dummy_faceted python:faceted_keys.sort()"
								 tal:repeat="faceted faceted_keys">
								 	<!--div>
								 		<span tal:content="faceted"/>
								 	</div-->
						<!--ITERATION FACETED-->					
						<div class="fieldsets" 
							tal:define="faceted_dict python:faceted_dict.get(faceted);
										faceted_name python:faceted_dict.get('index_name');
										faceted_elements python:faceted_dict.get('indexes_list');
										checked_faceted python:request.get(faceted_name,[]);"
							tal:condition="faceted_elements">
			                <h3 tal:content="faceted">Faceted Keyword</h3>
			            
								 <div tal:repeat="kw faceted_elements">
				                    <input type="checkbox"
				                           value="#"
				                           class="noborder"
				                           tal:attributes="name string:${faceted_name}:list; 
										   				   value python:kw;
				                           				   id string:${faceted_name}_${repeat/kw/number};
				                           				   checked python:kw in checked_faceted"/>
				
				                    <label for=""
										i18n:domain="plone-metadata"
										i18n:translate=""
										tal:attributes="for string:${faceted_name}_${repeat/kw/number};"
										tal:content="kw"
				                    	/>
				                    <br />
							</div>
							<div style="text-align:right"
								tal:condition="checked_faceted">
								<a class="portal-breadcrumbs"
									href="search"
									tal:condition="checked_faceted"
									onclick=""
									tal:attributes="id string:deselect-${faceted_name};
													onclick string:javascript:removeFacetedFilter('${faceted_name}');;return false">
									<span i18n:translate="label_remove_filters">Remove all filters</span>
								</a>
							</div>
							<input type="hidden"
								   tal:attributes="name string:${faceted_name}_usage:ignore_empty;
								   				   id string:${faceted_name}_and"
								   value="operator:and"/>
			 			</div>
					</tal:faceted>
					
		            <div class="visualClear" id="clear-space-before-submit"><!-- --></div>
		
		            <div class="formControls">
		                <input class="context"
		                       type="submit"
		                       name="submit"
		                       value="Search"
							   i18n:domain="plone"
		                       i18n:attributes="value label_search;"
		                       />
		            </div>
		
		        </fieldset>
		    
		    </form>
    	</tal:searchform>   
		</tal:search_view>
</div>
</body>
</html>

